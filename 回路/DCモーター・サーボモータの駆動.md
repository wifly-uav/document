# DCモーター・サーボモーターの駆動

- [DCモーター・サーボモーターの駆動](#dcモーターサーボモーターの駆動)
  - [PWM](#pwm)
  - [サーボモーター](#サーボモーター)
  - [DCモーター](#dcモーター)
    - [Hブリッジ回路](#hブリッジ回路)
    - [1スイッチ回路](#1スイッチ回路)


## PWM
DCモーター・サーボモーターの信号線はPWM信号という信号が使われていることが多い。
PWM（Pulse Wifth Modulation）回路とは、周期は一定で、パルス幅のDuty比（パルス幅とHighの比）を変え、モーターを制御する回路。逆にパルス幅は一定で、周期を変えるPPM回路というものもある。
PWMのパラメータは以下の通り。
- 電圧
- 周期
- Duty比(or 電圧がHighでいる時間)

<img src=./img/pwm_wave.png width=500>

## サーボモーター
重心移動機構や尾翼、Vectoringに使用しているモーター。
特性・仕組みは、機体/モーターで説明する。
サーボモーターではHighの時間を指定する。
周期としては10ms~20ms(100Hz-50Hz)であることが多い。PWM信号の生成にTimerを使用するため、マイコンによってはすべてのPWMピンが同じ周期になってしまうことがあるので注意。マイコンのデータシートでPWMに使われるTimerが共通かどうかで確認してほしい。
Highの時間は、サーボモーターの製品によるので購入元を確認してほしい。記述が無い場合は、恐らく1ms~2msが一般的。
サーボモーターが0-180°で動く場合、1msで0°,1.5msで90°,2msで180°に動く。しかし、安いサーボモーターでは範囲外のHigh時間を指定するとサーボモーターが壊れる可能性があるので注意。

## DCモーター
羽ばたかせるために使用しているモーター。
本来は、販売元に特性図が記載されているのでそれを用意する。特性図が用意されていない場合は、自作する必要がある。
モータ特性計算.xlsに必要なデータを入力すれば特性図が作成できる。
特性図が作成出来ない場合でも、最低限安定化電源等で実測してどのぐらい電流が流れているのか測定する必要がある。
詳細な特性については機体/モーターで説明する。
<img src=./img/motor.png width=500>

DCモーターでは、周期とDuty比(High/周期)を指定する。周期で制御性、Duty比で回転速度を変更できる。DCモーターの回転速度は、電流に比例するので電流を制御することになる。
モーターの過渡応答の電流をシミュレーションする。
<img src=./img/50khz.png width=500>
<img src=./img/10khz.png width=500>
上:50kHz, 下:10kHz
緑色のモーターに流れる電流を見ると50kHzは10kHzよりも上下に変動していない。これは、モーターの回転速度があまり変わらないことを意味する。このように制御周期を小さく（周波数を大きく）すると回転がより一定になり、制御性が増す。しかし、MOSFETのスイッチングが高速になる、回数が増えることで回路上で問題が発生するので無限に周期を小さくしていい訳ではない。基本的には、電流変動が+-5%以内にすれば良い。PWMがHighのとき、 i(t) = V/R(1-e^(-t/k)) ,PWMがLowのとき、i(t) = V/R e^(-t/k) (k=L/R)で変化するので周期Tに対して時定数kが10倍以上になれば良い。ただ、計算が面倒なので経験上だいたい10kHzぐらいで良い。
駆動させる際には、専用の回路を用意する必要がある。駆動回路としては、Hブリッジと1スイッチを説明する。

### Hブリッジ回路
ブラシ付きDCモーターの駆動では、Hブリッジ回路が一般的に使われる。Hブリッジ回路では、PWM信号を2つ使用して正転、逆転、回転速度を制御することができる。Hブリッジ回路の中でもハイサイドのMOSFETによってFullNかPNで分かれる。
<img src=./img/Hbridge.png width=500>
左:FullN  右:PN(分かりにくいので注意)
NchMOSFETの方が性能が良いのでFullNの方が一般的な気がする。 ただ、ハイサイドのNchに関してはゲート電圧が電源電圧を超えないといけないので昇圧回路が必要になる。何十A流すならFullNにすべきだが、1,2A程度ならPNでいいと思う。
Hブリッジ回路の駆動方法はSMB方式とLAP方式がある。
<img src=./img/smb.png width=500>
左:PWM1-Low,PWM2-High, 右:PWM1-High,PWM2-Low
|         |PWM1-High|PWM1-Low|
|---------|---------|--------|
|PWM2-High|回生ブレーキ|正転|
|PWM2-Low |逆転|回生ブレーキ(充電)|
SMB方式では、正転or逆転と回生ブレーキを交互に繰り返すことで回転速度（電流）を制御している。ハイサイドで回生ブレーキを行うと充電も行うことができるので効率的に回転させることができる。一般的には、このSMB方式が採用されている。
LAP方式では、正転と逆転を交互に繰り返すことで回転速度（電流）を制御している。回生ブレーキを使用しないため、制御性が良い。しかし、正転しているときに逆転するように電圧をかけるので効率が悪い。
SMB方式とLAP方式の制御性は下のようなグラフとなる。
<img src=./img/smb-lap.png width=500>

マイコンのPWM信号でMOSFETを動かそうとするといくつかの問題が発生する。
- 高速でスイッチングできない
- 過渡応答においてハイサイドとローサイドでどちらも電流が流れて一時的にショートする

これらに対応するためにゲートドライバーという専用のICを用いることが多い。同時にいくつのMOSFETを動かすかで名前が違い、Hブリッジの上下2つの場合は、ハーブブリッジドライバー、すべての場合は、フルブリッジドライバーと呼ばれる。これらのICを使うときには、入力信号やFullNかPNか、周辺回路に何が必要かなどデータシートをよく見て選定してほしい。

### 1スイッチ回路
現在、使用している回路。逆転することはできない。
<img src=./img/1switch.png width=200>
PchMOSFETを使っているが、Nchでも構わない。ただし、その場合は、モーターとGNDの間にNchMOSFETを入れること。